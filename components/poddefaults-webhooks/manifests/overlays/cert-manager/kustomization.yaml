# This overlay uses CertManager to provision a certificate for the
# PodDefaults admission controller. This is preferred over the old
# way of using "bootstrap" which was running a shell script to create
# the certificate.
# TODO(jlewi): We should eventually refactor the manifests to delete
# bootstrap and use certmanager by default.
bases:
- ../../base

resources:
- certificate.yaml

namespace: kubeflow

commonLabels:
  app: poddefaults
  kustomize.component: poddefaults
  app.kubernetes.io/component: poddefaults
  app.kubernetes.io/name: poddefaults

patchesStrategicMerge:
- mutating-webhook-configuration.yaml
- deployment.yaml

generatorOptions:
  disableNameSuffixHash: true

replacements:
# Replacements for the Certificate
- source:
    fieldPath: metadata.name
    kind: Service
    name: service
    version: v1
  targets:
  - fieldPaths:
    - spec.commonName
    - spec.dnsNames.0
    - spec.dnsNames.1
    options:
      delimiter: .
      index: 0
    select:
      group: cert-manager.io
      kind: Certificate
      version: v1
- source:
    fieldPath: metadata.namespace
    kind: Service
    name: service
    version: v1
  targets:
  - fieldPaths:
    - spec.commonName
    - spec.dnsNames.0
    - spec.dnsNames.1
    options:
      delimiter: .
      index: 1
    select:
      group: cert-manager.io
      kind: Certificate
      version: v1

# Replacements for the MutatingWebhookCOnfiguration
- source:
    fieldPath: metadata.namespace
    group: cert-manager.io
    kind: Certificate
    version: v1
  targets:
  - fieldPaths:
    - metadata.annotations.[cert-manager.io/inject-ca-from]
    options:
      delimiter: /
      index: 0
    select:
      group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      version: v1
- source:
    fieldPath: metadata.name
    group: cert-manager.io
    kind: Certificate
    version: v1
  targets:
  - fieldPaths:
    - metadata.annotations.[cert-manager.io/inject-ca-from]
    options:
      delimiter: /
      index: 1
    select:
      group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      version: v1

configurations:
- params.yaml
